name: Grade Student Submission

on:
  workflow_dispatch:  # Manual trigger from GitHub Actions UI
    inputs:
      student_repo:
        description: 'Student repository name (optional - defaults to current repo)'
        required: false
        type: string
      debug_mode:
        description: 'Enable debug logging'
        required: false
        type: boolean
        default: false

jobs:
  grade-submission:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Maximum 60 minutes for entire grading process
    
    steps:
      # ============================================
      # STEP 1: CHECKOUT & SETUP
      # ============================================
      - name: üì• Checkout Student Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for git analysis
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # MongoDB not needed for Module 2 (Frontend-only React/Vite project)
      # - name: üóÑÔ∏è Setup MongoDB
      #   uses: supercharge/mongodb-github-action@1.10.0
      
      - name: üîß Install System Dependencies
        run: |
          echo "Installing jq for JSON processing..."
          sudo apt-get update -qq
          sudo apt-get install -y jq
      
      # ============================================
      # STEP 2: VALIDATE SUBMISSION
      # ============================================
      - name: üìã Validate Required Files
        id: validate
        run: |
          echo "üîç Checking for required files and folders..."
          
          # Check for grading folder
          if [ ! -d "grading-folder" ]; then
            echo "‚ùå ERROR: grading-folder/ directory not found"
            echo "validation_failed=true" >> $GITHUB_OUTPUT
            echo "error_message=Missing grading-folder directory" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check for src folder (Module 2 React/Vite structure)
          if [ ! -d "grading-folder/src" ]; then
            echo "‚ö†Ô∏è  WARNING: grading-folder/src/ not found"
            echo "missing_src=true" >> $GITHUB_OUTPUT
          fi
          
          # Check for package.json in grading-folder
          if [ ! -f "grading-folder/package.json" ]; then
            echo "‚ö†Ô∏è  WARNING: grading-folder/package.json not found"
            echo "missing_grading_package=true" >> $GITHUB_OUTPUT
          fi
          
          # Check for deployment URL
          if [ ! -f "DEPLOYMENT_URL.txt" ]; then
            echo "‚ö†Ô∏è  WARNING: DEPLOYMENT_URL.txt not found"
            echo "missing_deployment_url=true" >> $GITHUB_OUTPUT
          fi
          
          # Check for package.json files
          if [ ! -f "package.json" ]; then
            echo "‚ö†Ô∏è  WARNING: Root package.json not found"
            echo "missing_root_package=true" >> $GITHUB_OUTPUT
          fi
          
          echo "‚úÖ Validation complete"
          echo "validation_failed=false" >> $GITHUB_OUTPUT
      
      # ============================================
      # STEP 3: INSTALL DEPENDENCIES
      # ============================================
      - name: üì¶ Install Root Dependencies
        if: steps.validate.outputs.validation_failed != 'true'
        run: |
          echo "üì¶ Installing root dependencies..."
          if [ -f "package.json" ]; then
            npm install || echo "‚ö†Ô∏è  Root npm install failed"
          fi
      
      - name: üì¶ Install Grading Script Dependencies
        run: |
          echo "üì¶ Installing grading script dependencies..."
          # Dependencies are in root package.json for Module 2
          npm install || echo "‚ö†Ô∏è  Root npm install had issues"
      
      - name: üì¶ Install Grading Folder Dependencies (React/Vite)
        if: steps.validate.outputs.validation_failed != 'true' && steps.validate.outputs.missing_grading_package != 'true'
        continue-on-error: true
        run: |
          echo "üì¶ Installing grading-folder dependencies..."
          cd grading-folder
          if [ -f "package.json" ]; then
            npm install --legacy-peer-deps || echo "‚ö†Ô∏è  Grading folder dependencies installation had issues"
          fi
          cd ..
      
      # ============================================
      # STEP 4: BUILD PROJECT
      # ============================================
      - name: üèóÔ∏è  Build React/Vite Project
        id: build_frontend
        if: steps.validate.outputs.validation_failed != 'true'
        continue-on-error: true
        run: |
          echo "üèóÔ∏è  Building React/Vite project..."
          cd grading-folder
          
          # Create .env for build if needed (Vite uses .env)
          if [ ! -f ".env" ] && [ ! -f ".env.production" ]; then
            echo "Creating temporary .env for build..."
            cat > .env << EOF
          VITE_APP_NAME=Restaurant
          NODE_ENV=production
          EOF
          fi
          
          # Try to build with Vite
          npm run build 2>&1 | tee ../build.log || {
            echo "‚ùå Build failed"
            echo "build_failed=true" >> $GITHUB_OUTPUT
            echo "build_error<<EOF" >> $GITHUB_OUTPUT
            tail -50 ../build.log >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            cd ..
            exit 0
          }
          
          cd ..
          echo "‚úÖ Build successful"
          echo "build_failed=false" >> $GITHUB_OUTPUT
      
      - name: üìä Build Status Summary
        run: |
          echo "## üèóÔ∏è  Build Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.build_frontend.outputs.build_failed }}" == "true" ]; then
            echo "‚ùå **Build Failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Error Details:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.build_frontend.outputs.build_error }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **Build Successful**" >> $GITHUB_STEP_SUMMARY
          fi
      
      # ============================================
      # STEP 5: SETUP TEST ENVIRONMENT
      # ============================================
      - name: üîß Setup Test Environment
        if: steps.validate.outputs.validation_failed != 'true'
        run: |
          echo "üîß Setting up test environment for Module 2..."
          
          # Create test .env file (minimal for frontend tests)
          cat > .env.test << EOF
          NODE_ENV=test
          VITE_APP_NAME=Restaurant
          EOF
          
          # Copy to grading-folder if needed
          cp .env.test grading-folder/.env 2>/dev/null || true
          
          echo "‚úÖ Test environment ready"
      
      # ============================================
      # STEP 6: RUN UNIT TESTS
      # ============================================
      - name: üß™ Run Unit Tests
        id: unit_tests
        if: steps.validate.outputs.validation_failed != 'true'
        continue-on-error: true
        env:
          NODE_ENV: test
        run: |
          echo "üß™ Running unit tests..." >&2
          node grading-scripts/run-unit-tests.js > unit-test-results.json
          
          # Check if tests ran successfully
          if [ $? -eq 0 ]; then
            echo "unit_tests_completed=true" >> $GITHUB_OUTPUT
          else
            echo "unit_tests_completed=false" >> $GITHUB_OUTPUT
          fi
          
          # Display summary
          if [ -f "unit-test-results.json" ]; then
            echo "## üß™ Unit Test Results" >> $GITHUB_STEP_SUMMARY
            node -e "
              const results = require('./unit-test-results.json');
              console.log('**Total Tests:** ' + results.total_tests);
              console.log('**Passed:** ' + results.passed + ' ‚úÖ');
              console.log('**Failed:** ' + results.failed + ' ‚ùå');
              console.log('**Success Rate:** ' + results.success_rate + '%');
      # STEP 7: ANALYZE GIT HISTORY
      # ============================================
      - name: üìú Analyze Git History
        id: git_analysis
        if: steps.validate.outputs.validation_failed != 'true'
        run: |
          echo "üìú Analyzing git commit history..." >&2
          node grading-scripts/analyze-git-history.js > git-analysis.json
          
          echo "## üìú Git History Analysis" >> $GITHUB_STEP_SUMMARY
          if [ -f "git-analysis.json" ] && jq empty git-analysis.json 2>/dev/null; then
            node -e "
              const analysis = require('./git-analysis.json');
              console.log('**Total Commits:** ' + analysis.total_commits);
              console.log('**Commit Frequency:** ' + analysis.commit_frequency);
              console.log('**Meaningful Messages:** ' + analysis.commit_message_quality.meaningful);
              console.log('**Vague Messages:** ' + analysis.commit_message_quality.vague);
            " >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Git analysis output invalid or missing" >> $GITHUB_STEP_SUMMARY
          fi
      
      # ============================================
      # STEP 8: CODE ANALYSIS & SUMMARIZATION
      # ============================================
      - name: üìù Summarize Code for GPT Analysis
        id: code_summary
        if: steps.validate.outputs.validation_failed != 'true'
        run: |
          echo "üìù Generating code summaries..." >&2
          node grading-scripts/code-summarizer.js > code-summaries.json
          
          # Check file size and validity
          if [ -f "code-summaries.json" ] && jq empty code-summaries.json 2>/dev/null; then
            summary_size=$(wc -c < code-summaries.json)
            echo "üìä Code summary size: $summary_size bytes" >&2
            echo "‚úÖ Code summary generated successfully" >&2
            echo "code_summary_completed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Code summary generation failed or produced invalid JSON" >&2
            if [ -f "code-summaries.json" ]; then
              echo "First 500 chars of output:" >&2
              head -c 500 code-summaries.json >&2
            fi
            echo "code_summary_completed=false" >> $GITHUB_OUTPUT
          fi
      
      # ============================================
      # STEP 9: GPT-4O EVALUATION
      # ============================================
      - name: ü§ñ GPT-4o Code Evaluation
        id: gpt_evaluation
        if: steps.validate.outputs.validation_failed != 'true' && steps.code_summary.outputs.code_summary_completed == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ü§ñ Running GPT-4o evaluation..." >&2
          
          # Check if API key exists
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "‚ùå ERROR: OPENAI_API_KEY not set in repository secrets" >&2
            echo "gpt_evaluation_failed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Run GPT evaluation (stdout to file, stderr to terminal for logging)
          node grading-scripts/gpt-evaluator.js > gpt-evaluation.json
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -eq 0 ] && [ -f "gpt-evaluation.json" ]; then
            # Verify JSON is valid
            if jq empty gpt-evaluation.json 2>/dev/null; then
              echo "‚úÖ GPT evaluation completed" >&2
              echo "gpt_evaluation_completed=true" >> $GITHUB_OUTPUT
              
              # Add summary
              echo "## ü§ñ GPT-4o Evaluation" >> $GITHUB_STEP_SUMMARY
              echo "‚úÖ Evaluation completed successfully" >> $GITHUB_STEP_SUMMARY
              
              # Show API usage
              api_calls=$(jq '.metadata.total_api_calls // 0' gpt-evaluation.json)
              echo "**API Calls Made:** $api_calls" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå GPT evaluation produced invalid JSON" >&2
              echo "First 500 chars of output:" >&2
              head -c 500 gpt-evaluation.json >&2
              echo "gpt_evaluation_completed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå GPT evaluation failed with exit code $EXIT_CODE" >&2
            echo "gpt_evaluation_completed=false" >> $GITHUB_OUTPUT
          fi
      
      # ============================================
      # STEP 10: TEST DEPLOYMENT
      # ============================================
      - name: üåê Test Deployment URL
        id: deployment_test
        if: steps.validate.outputs.validation_failed != 'true' && steps.validate.outputs.missing_deployment_url != 'true'
        continue-on-error: true
        run: |
          echo "üåê Testing deployment URL..."
          
          if [ -f "DEPLOYMENT_URL.txt" ]; then
            DEPLOY_URL=$(cat DEPLOYMENT_URL.txt | tr -d '\r\n' | xargs)
            echo "Testing URL: $DEPLOY_URL"
            
            # Run deployment tests (using Jest tests in tests/deployment/)
            npm test tests/deployment/ -- --json > deployment-test.json || echo "Deployment tests completed with issues"
            
            if [ $? -eq 0 ]; then
              echo "deployment_test_completed=true" >> $GITHUB_OUTPUT
              echo "## üåê Deployment Test" >> $GITHUB_STEP_SUMMARY
              echo "‚úÖ Deployment URL is accessible" >> $GITHUB_STEP_SUMMARY
              echo "**URL:** $DEPLOY_URL" >> $GITHUB_STEP_SUMMARY
            else
              echo "deployment_test_completed=false" >> $GITHUB_OUTPUT
              echo "## üåê Deployment Test" >> $GITHUB_STEP_SUMMARY
              echo "‚ùå Deployment URL test failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ö†Ô∏è  No deployment URL found"
            echo "deployment_test_completed=false" >> $GITHUB_OUTPUT
          fi
      
      # ============================================
      # STEP 11: GENERATE FINAL REPORT
      # ============================================
      - name: üìä Generate Final Grading Report
        id: generate_report
        if: always()
        env:
          VALIDATION_FAILED: ${{ steps.validate.outputs.validation_failed }}
          BUILD_FAILED: ${{ steps.build_frontend.outputs.build_failed }}
          UNIT_TESTS_COMPLETED: ${{ steps.unit_tests.outputs.unit_tests_completed }}
          GPT_EVALUATION_COMPLETED: ${{ steps.gpt_evaluation.outputs.gpt_evaluation_completed }}
          DEPLOYMENT_TEST_COMPLETED: ${{ steps.deployment_test.outputs.deployment_test_completed }}
        run: |
          echo "üìä Generating final grading report..."
          
          # Generate comprehensive report
          node grading-scripts/generate-report.js \
            --unit-tests=unit-test-results.json \
            --git-analysis=git-analysis.json \
            --code-summaries=code-summaries.json \
            --gpt-evaluation=gpt-evaluation.json \
            --deployment-test=deployment-test.json \
            --rubric=rubric.json \
            --output=GRADING_REPORT.md
          
          if [ -f "GRADING_REPORT.md" ]; then
            echo "‚úÖ Report generated successfully"
            echo "report_generated=true" >> $GITHUB_OUTPUT
            
            # Display report summary in job summary
            echo "# üìä Grading Report Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract key information from report
            if command -v grep &> /dev/null; then
              grep "^## Executive Summary" -A 5 GRADING_REPORT.md >> $GITHUB_STEP_SUMMARY || true
              echo "" >> $GITHUB_STEP_SUMMARY
              grep "^**Total Score:**" GRADING_REPORT.md >> $GITHUB_STEP_SUMMARY || true
              grep "^**Grade:**" GRADING_REPORT.md >> $GITHUB_STEP_SUMMARY || true
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üìÑ **Full report available in artifacts**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Report generation failed"
            echo "report_generated=false" >> $GITHUB_OUTPUT
          fi
      
      # ============================================
      # STEP 12: UPLOAD ARTIFACTS
      # ============================================
      - name: üì§ Upload Grading Report
        if: always() && steps.generate_report.outputs.report_generated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: grading-report-${{ github.run_number }}
          path: GRADING_REPORT.md
          retention-days: 90
      
      - name: üì§ Upload Detailed Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: grading-details-${{ github.run_number }}
          path: |
            unit-test-results.json
            git-analysis.json
            code-summaries.json
            gpt-evaluation.json
            deployment-test.json
            build.log
          retention-days: 90
      
      # ============================================
      # STEP 13: FINAL STATUS
      # ============================================
      - name: üéØ Grading Complete
        if: always()
        run: |
          echo "======================================"
          echo "üéØ GRADING COMPLETE"
          echo "======================================"
          echo ""
          
          if [ "${{ steps.generate_report.outputs.report_generated }}" == "true" ]; then
            echo "‚úÖ Grading report generated successfully"
            echo "üìÑ Download the report from the Artifacts section"
            echo ""
            
            # Display quick stats
            if [ -f "GRADING_REPORT.md" ]; then
              echo "Quick Stats:"
              grep "^**Total Score:**" GRADING_REPORT.md || echo "Score: See report"
              grep "^**Grade:**" GRADING_REPORT.md || echo "Grade: See report"
            fi
          else
            echo "‚ö†Ô∏è  Grading completed with issues"
            echo "Please check the logs and artifacts for details"
          fi
          
          echo ""
          echo "======================================"